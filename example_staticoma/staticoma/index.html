<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>staticoma: Staticoma -- static configuration manager</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">staticoma
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Staticoma -- static configuration manager </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>[Disclaimer: this is a proof of concept, not mature software]</p>
<p>ROS utility package for build-time configuration file generation and dumping/restoring contents of ROS parameter server to/from ROS bags.</p>
<p>Dependencies:</p><ul>
<li><code>yq</code> &ndash; <a href="https://mikefarah.gitbook.io/yq/">https://mikefarah.gitbook.io/yq/</a></li>
<li><code>cmake</code></li>
<li><code>catkin</code></li>
<li><code>ROS</code> (<code>std_msgs</code>)</li>
<li><code>Boost</code></li>
</ul>
<p>Demo workspace -&gt; <a href="https://github.com/asherikov/colcon_workspace/tree/example_staticoma">https://github.com/asherikov/colcon_workspace/tree/example_staticoma</a></p>
<p>The following terms are not common, but useful for definition of the problems addressed by staticoma:</p>
<ul>
<li>Configuration parameters can be divided into three categories:<ol type="1">
<li>build-time &ndash; values are known during compilation and never change;</li>
<li>launch-time &ndash; values are known at launch time and never change during execution;</li>
<li>run-time &ndash; those that change dynamically during execution.</li>
</ol>
</li>
<li>Stack &ndash; a robot-specific set of packages providing multiple services and configuration parameters for them. Usually there are at least two partially overlapping stacks for a specific robot: one for simulation, and one for deployments.</li>
<li>Configuration composition &ndash; construction of configuration parameters from multiple, potentially overlapping pieces scattered among multiple (ROS) packages in a stack. Roughly speaking default parameters defined by packages providing certain functionality are overlayed with robot-sepecific parameters.</li>
</ul>
<p><code>roslaunch</code> (<a href="http://wiki.ros.org/roslaunch">http://wiki.ros.org/roslaunch</a>) &ndash; ROS subsystem designed for ROS-specific service management, provides two options to pass parameters to a specific node (service):</p>
<ul>
<li>individual parameters can be passed via command line, but due to nested structure of roslaunch scripts such parameters often must be passed from top level to lower level scripts through a chain of intermediate scripts;</li>
<li>parameters can be uploaded from YAML files to 'parameter server' (<a href="http://wiki.ros.org/Parameter%20Server">http://wiki.ros.org/Parameter%20Server</a>) &ndash; ROS service which manages global parameters at run-time, sequential uploading of parameters allows configuration composition.</li>
</ul>
<p><code>roslaunch</code> ensures that parameters declared in the stack launch script tree are uploaded to parameter server in the order of their appearance before any of the nodes are started.</p>
<p><code>staticoma</code> addresses build-time and launch-time parameter management in order to alleviate some of parameter server issues:</p>
<ol type="1">
<li>ROS allows recording data exchange between nodes using <code>rosbag</code> utility. The problem is that the content of ROS parameter server is not saved to bag files, but often affects data exchange. <code>staticoma</code> introduces a workaround that allows storing configurations in bag files, making them self-sufficient.</li>
<li>Launch-time configuration composition performed by <code>roslaunch</code> may be confusing since configuration pieces are stored in different locations and their precedence may not be straightforward. This problem is alleviated by performing build-time parameter composition to a single configuration file.</li>
<li>Node parameters may be removed or renamed during development, it would be nice to have a mechanism to enforce parameter consistency between 'parameter consumer' and 'parameter provider' packages. This goal is achieved by preventing providers from adding new parameters during build-time composition.</li>
<li>ROS parameter server has been deprecated in ROS2, and it is a good idea to develop services that do not rely on it.</li>
<li><code>roslaunch</code> is inferior in many aspects to generic service managers such as <code>systemd</code>, but replacing it is very difficult due to deep integration with parameter server. Limited dependency on parameter server would allow to explore alternatives to <code>roslaunch</code>.</li>
</ol>
<h3>Handling build-time parameters</h3>
<ol type="1">
<li>All build-time parameters of a stack are written to a single file during compilation ('stack-config') using custom <code>cmake</code> functions.</li>
<li>stack-config is composed step by step by overlaying parameter files provided by package dependencies. For example: package B depends on A, A defines build-time parameters (<a href="https://github.com/asherikov/staticoma_workspace/blob/master/src/package_a/CMakeLists.txt#L15">https://github.com/asherikov/staticoma_workspace/blob/master/src/package_a/CMakeLists.txt#L15</a>): <div class="fragment"><div class="line">staticoma_export(&quot;config/base_config.yaml&quot;)</div></div><!-- fragment --> and B builds on top of them (<a href="https://github.com/asherikov/staticoma_workspace/blob/master/src/package_b/CMakeLists.txt#L17">https://github.com/asherikov/staticoma_workspace/blob/master/src/package_b/CMakeLists.txt#L17</a>) <div class="fragment"><div class="line">staticoma_compose(</div><div class="line">    merged_config.yaml</div><div class="line">    package_a base_config.yaml</div><div class="line">    package_b &quot;config/extended_config.yaml&quot;</div><div class="line">)</div></div><!-- fragment --> <code>merged_config.yaml</code> can in turn be used by other packages (<a href="https://github.com/asherikov/staticoma_workspace/blob/master/src/package_c/CMakeLists.txt#L28">https://github.com/asherikov/staticoma_workspace/blob/master/src/package_c/CMakeLists.txt#L28</a>), etc.</li>
<li>If it is necessary to prevent package B from addiing new parameters to configuration file provided by A, then <code>STRICT</code> keyword can be used, e.g., <div class="fragment"><div class="line">staticoma_compose(</div><div class="line">    merged_config.yaml</div><div class="line">    STRICT</div><div class="line">    package_a base_config.yaml</div><div class="line">    package_b &quot;config/extended_config.yaml&quot;</div><div class="line">)</div></div><!-- fragment --></li>
<li>There exist different merging strategies for <code>YAML</code> arrays, <code>roslaunch</code> supports only 'overwrite' strategy, where the contents of an array is completely overriden if the redefined in overlaying parameters. <code>staticoma</code> uses the same strategy by default, but also supports 'append' strategy, which extends arrays with new members, e.g. (<a href="https://github.com/asherikov/staticoma_workspace/blob/master/src/package_c/CMakeLists.txt#L20">https://github.com/asherikov/staticoma_workspace/blob/master/src/package_c/CMakeLists.txt#L20</a>): <div class="fragment"><div class="line">staticoma_compose(</div><div class="line">    merged_config.yaml</div><div class="line">    ARRAY_MERGE_STRATEGY append</div><div class="line">    package_a base_config.yaml</div><div class="line">    package_b extended_config.yaml</div><div class="line">)</div></div><!-- fragment --></li>
<li>Global or partial (in some cases) stack-config can be used for partial stack launches, which is convenient for development.</li>
<li>A dedicated service <code>staticoma/server</code> reads stack-config on launch and advertises it as a static topic (<code>stack-config-topic</code>), which can be recorded in a bag file.</li>
<li>It is not very safe to rely completely on <code>staticoma</code> server, therefore nodes should prefer reading stack-config directly from a file.</li>
<li>Passing of stack-config filename:<ul>
<li>environment variable &ndash; should be used by default (<a href="https://github.com/asherikov/staticoma/blob/master/test/client.test#L4">https://github.com/asherikov/staticoma/blob/master/test/client.test#L4</a>);</li>
<li>command line argument &ndash; can be provided by the user if necessary.</li>
</ul>
</li>
<li>Initialization of stack-config in a node:<ol type="a">
<li>if stack-config filename is given explicitly, open this file, fail if does not exist.</li>
<li>if environment variable specifying stack-config filename exists, use it to locate the file, fail if does not exist.</li>
<li>if stack-config filename cannot be determined try accessing <code>stack-config-topic</code>, fail if not available.</li>
<li>Once the content of stack-config has been received, the node can parse and use it as necessary.</li>
</ol>
</li>
<li>Some parameters, such as robot description, must be set in parameter server, so we cannot get rid of parameter server completely. <code>staticoma</code> server can dump all parameters and publish them in a message to be saved in bag files.</li>
<li>Restoring of parameter server content from a bag file should be performed by an additional <code>replayer</code> service that would be executed alongside <code>rosbag play</code>.</li>
<li><code>replayer</code> can be started in two ways:<ul>
<li>as a normal ROS node &ndash; <a href="https://github.com/asherikov/staticoma/blob/master/test/client_replay1.test#L7">https://github.com/asherikov/staticoma/blob/master/test/client_replay1.test#L7</a>), in this case parameters are not guaranteed to be uploaded before other nodes are started;</li>
<li>inside <code>&lt;param&gt;</code> roslaunch tag &ndash; <a href="https://github.com/asherikov/staticoma/blob/master/test/client_replay3.test#L7">https://github.com/asherikov/staticoma/blob/master/test/client_replay3.test#L7</a>.</li>
</ul>
</li>
</ol>
<h3>Handling launch-time and run-time parameters</h3>
<ol type="1">
<li>Although launch-time parameter values are unknown at build-time, we usually know which services provide them, in case of roslaunch scripts this information is implicitly hardcoded.</li>
<li>A unique topic can be allocated for each dynamic provider known at build time. Publishing parameters on topics is also going to make them 'rosbaggable'. Topic name collisions can be avoided by using naming conventions, e.g.,: <code>/&lt;consumer_id&gt;/&lt;provider_id&gt;/&lt;topic_name&gt;</code>.</li>
<li>Parameter consumer may receive parameters from multiple sources, conflict resolution is implementation specific, for example, overlay them in order of provider declaration, or instantiate a separate processing thread for each.</li>
<li>roslaunch <code>arg</code>, <code>param</code>, and <code>rosparam</code> tags can be replaced with nodes starting rostopic with <code>rostopic pub --latch</code> nodes, e.g. <a href="https://github.com/asherikov/staticoma_workspace/blob/master/src/package_b/launch/node.launch#L3">https://github.com/asherikov/staticoma_workspace/blob/master/src/package_b/launch/node.launch#L3</a>.</li>
<li>Consuming parameters (<a href="https://github.com/asherikov/staticoma_workspace/blob/master/src/package_c/src/node.cpp#L101">https://github.com/asherikov/staticoma_workspace/blob/master/src/package_c/src/node.cpp#L101</a>):<ol type="a">
<li>obtain stack-config to identify parameter providers.</li>
<li>wait for published parameters</li>
<li>parse parameters</li>
</ol>
</li>
</ol>
<h3>Parameter representation</h3>
<ol type="1">
<li><code>staticoma</code> does not depend on parameter representation, it can be <code>JSON</code>, <code>YAML</code>, <code>XML</code>, etc, as long as we have tools to compose them at build-time and parse in nodes. Currently, only <code>YAML</code> is supported.</li>
<li>Configuration files are passed raw (plain YAML, etc): performance and throughput are not important since parameters are static in run-time and need not be frequently transferred.</li>
</ol>
<h3>Other considerations</h3>
<ol type="1">
<li>If we remove all conditional logic, arguments, and parameters from launch files, they are pretty much build-time configuration files, which can be composed at build-time as well. This may be useful if we would like to use something like <code>supervisord</code> for service management, since it uses single configuration file instead of multiple 'unit'/'launch' files.</li>
<li>It could be interesting to consider migration from YAML to jsonnet. Jsonnet is a data templating language (<a href="https://jsonnet.org/">https://jsonnet.org/</a>) which has build-in JSON merging functionality and a lot of other functions.</li>
</ol>
<ul>
<li><a href="https://github.com/hordurk/rosbag_metadata">https://github.com/hordurk/rosbag_metadata</a> &ndash; Tool for collecting and writing metadata to ROS bagfiles or to accompanying yaml files. </li>
</ul>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
